# ============================================================================
# Tmux Configuration (clean & organized)
# Sections:
#   1. Terminal & General
#   2. Prefix & Core Key Bindings
#   3. Pane Resizing / Zoom
#   4. Copy Mode (vi)
#   5. Performance / Timing Tweaks
#   6. Plugins (TPM)
#   7. Theme (Catppuccin)
#   8. Status Line Modules
#   9. Window Indexing & History
#  10. Splits / Swaps / New Windows
#  11. Vim-aware Pane Navigation
#  12. TPM Initialization
# ============================================================================

# ----------------------------------------------------------------------------
# 1. Terminal & General
# ----------------------------------------------------------------------------
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -g mouse on

# ----------------------------------------------------------------------------
# 2. Prefix & Core Key Bindings
# ----------------------------------------------------------------------------
set -g prefix C-a
unbind C-b
bind-key C-a send-prefix

unbind r
bind r source-file $HOME/.tmux.conf # reload config

# Safer pane kill
bind x kill-pane

# ----------------------------------------------------------------------------
# 3. Pane Resizing / Zoom
# ----------------------------------------------------------------------------
bind j resize-pane -D 5
bind k resize-pane -U 5
bind l resize-pane -R 5
bind h resize-pane -L 5
bind -r m resize-pane -Z   # toggle zoom (repeatable)

# ----------------------------------------------------------------------------
# 4. Copy Mode (vi)
# ----------------------------------------------------------------------------
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v send -X begin-selection   # start selection
bind-key -T copy-mode-vi y send -X copy-selection    # yank selection
unbind -T copy-mode-vi MouseDragEnd1Pane             # keep copy-mode after drag

# ----------------------------------------------------------------------------
# 5. Performance / Timing Tweaks
# ----------------------------------------------------------------------------
# Lower escape delay (helps Neovim / Helix responsiveness)
set -sg escape-time 10
set -g status-interval 2  # status refresh cadence (in seconds)
set-option -g history-limit 10000

# ----------------------------------------------------------------------------
# 6. Plugins (TPM)
# ----------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'catppuccin/tmux'
# Optional session persistence:
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
# set -g @resurrect-capture-pane-contents 'on'
# set -g @continuum-restore 'on'

# ----------------------------------------------------------------------------
# 7. Theme (Catppuccin) Configuration
# ----------------------------------------------------------------------------
set -g @catppuccin_flavor "mocha" # latte, frappe, macchiato, mocha
set -g @catppuccin_pane_status_enabled "no"
set -g @catppuccin_pane_border_status "off"
set -g @catppuccin_window_status_style "basic"
# Window text (show window_name unless it matches the running command, then show command)
set -g @catppuccin_window_text " #{?#{!=:#{window_name},#{pane_current_command}},#{window_name},#{pane_current_command}}"
set -g @catppuccin_window_current_text " #{?#{!=:#{window_name},#{pane_current_command}},#{window_name},#{pane_current_command}}"

# ----------------------------------------------------------------------------
# 8. Status Line Modules
# ----------------------------------------------------------------------------
set -g status-position "bottom"

# Left side
set -g status-left-length 80
set -g status-left ""
set -ga status-left "#[fg=#{@thm_mantle},bg=#{@thm_green}]#{?client_prefix,#[bg=#{@thm_red}]#[bold],} #[none]"

# Right side
set -g status-right-length 160
set -g status-right ""

# Git segment (icon + branch). Fully silent outside git repos.
set -ga status-right "#[fg=#{@thm_mantle},bg=#{@thm_green}]#(git -C '#{pane_current_path}' rev-parse --is-inside-work-tree >/dev/null 2>&1 && printf ' ')"
set -ga status-right "#[fg=#{@thm_green},bg=#{@thm_mantle}] #(git -C '#{pane_current_path}' rev-parse --is-inside-work-tree >/dev/null 2>&1 && git -C '#{pane_current_path}' rev-parse --abbrev-ref HEAD 2>/dev/null) "

# Current directory segment (icon + path)
set -ga status-right "#[fg=#{@thm_mantle},bg=#{@thm_blue}]󰉋 #[fg=#{@thm_blue},bg=#{@thm_mantle}] #{b:pane_current_path} "

# ----------------------------------------------------------------------------
# 9. Window Indexing & History
# ----------------------------------------------------------------------------
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# ----------------------------------------------------------------------------
# 10. Splits / Swaps / New Windows
# ----------------------------------------------------------------------------
bind-key '|' split-window -h -c "#{pane_current_path}"
bind-key "\\" split-window -h -c "#{pane_current_path}"
bind-key '-' split-window -v -c "#{pane_current_path}"
bind-key '_' split-window -fv -c "#{pane_current_path}"

bind -r '<' swap-window -d -t -1
bind -r '>' swap-window -d -t +1

bind c new-window -c "#{pane_current_path}"
bind Space last-window

# ----------------------------------------------------------------------------
# 11. Vim-aware Pane Navigation (supports vim/neovim/helix/lazygit, extensible)
# ----------------------------------------------------------------------------
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n C-S-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind-key -n C-S-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind-key -n C-S-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind-key -n C-S-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# ----------------------------------------------------------------------------
# 12. TPM Initialization (must remain at end of file)
# ----------------------------------------------------------------------------
run '~/.tmux/plugins/tpm/tpm'
